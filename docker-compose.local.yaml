# Standalone local development compose file
# Usage: docker compose -f docker-compose.local.yaml up -d

services:
  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=${SERVICE_PASSWORD_64_MYSQLROOT}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-mautic}
      - MYSQL_USER=${SERVICE_USER_MYSQL}
      - MYSQL_PASSWORD=${SERVICE_PASSWORD_64_MYSQL}
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: mysqladmin ping --silent --user=$$SERVICE_USER_MYSQL --password=$$SERVICE_PASSWORD_64_MYSQL
      start_period: 30s
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3
    environment:
      - RABBITMQ_DEFAULT_VHOST=${RABBITMQ_DEFAULT_VHOST:-mautic}
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 5s
      timeout: 30s
      retries: 10

  mautic_web:
    build:
      dockerfile: Dockerfile
    ports:
      - "${MAUTIC_PORT:-8080}:80"
    volumes:
      - ./mautic_data/config:/var/www/html/config:z
      - ./mautic_data/logs:/var/www/html/var/logs:z
      - ./mautic_data/media/files:/var/www/html/docroot/media/files:z
      - ./mautic_data/media/images:/var/www/html/docroot/media/images:z
    environment:
      - SERVICE_URL_MAUTIC_80=${SERVICE_URL_MAUTIC_80:-http://localhost:8080}
      - DOCKER_MAUTIC_LOAD_TEST_DATA=${MAUTIC_LOAD_TEST_DATA:-false}
      - DOCKER_MAUTIC_RUN_MIGRATIONS=${MAUTIC_RUN_MIGRATIONS:-false}
      - MAUTIC_DB_HOST=${MYSQL_HOST:-mysql}
      - MAUTIC_DB_PORT=${MYSQL_PORT:-3306}
      - MAUTIC_DB_DATABASE=${MYSQL_DATABASE:-mautic}
      - MAUTIC_DB_USER=${SERVICE_USER_MYSQL}
      - MAUTIC_DB_PASSWORD=${SERVICE_PASSWORD_64_MYSQL}
      - MAUTIC_MESSENGER_DSN_EMAIL=${MAUTIC_MESSENGER_DSN_EMAIL:-amqp://guest:guest@rabbitmq:5672/mautic/messages}
      - MAUTIC_MESSENGER_DSN_HIT=${MAUTIC_MESSENGER_DSN_HIT:-amqp://guest:guest@rabbitmq:5672/mautic/messages}
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 15s
      timeout: 10s
      retries: 15

  mautic_cron:
    image: mautic/mautic:latest
    volumes:
      - ./mautic_data/config:/var/www/html/config:z
      - ./mautic_data/logs:/var/www/html/var/logs:z
      - ./mautic_data/media/files:/var/www/html/docroot/media/files:z
      - ./mautic_data/media/images:/var/www/html/docroot/media/images:z
    environment:
      - DOCKER_MAUTIC_ROLE=mautic_cron
      - MAUTIC_DB_HOST=${MYSQL_HOST:-mysql}
      - MAUTIC_DB_PORT=${MYSQL_PORT:-3306}
      - MAUTIC_DB_DATABASE=${MYSQL_DATABASE:-mautic}
      - MAUTIC_DB_USER=${SERVICE_USER_MYSQL}
      - MAUTIC_DB_PASSWORD=${SERVICE_PASSWORD_64_MYSQL}
      - MAUTIC_MESSENGER_DSN_EMAIL=${MAUTIC_MESSENGER_DSN_EMAIL:-amqp://guest:guest@rabbitmq:5672/mautic/messages}
      - MAUTIC_MESSENGER_DSN_HIT=${MAUTIC_MESSENGER_DSN_HIT:-amqp://guest:guest@rabbitmq:5672/mautic/messages}
    depends_on:
      mautic_web:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exit 0"]
      interval: 5s
      timeout: 10s
      retries: 15

  mautic_worker:
    image: mautic/mautic:latest
    volumes:
      - ./mautic_data/config:/var/www/html/config:z
      - ./mautic_data/logs:/var/www/html/var/logs:z
      - ./mautic_data/media/files:/var/www/html/docroot/media/files:z
      - ./mautic_data/media/images:/var/www/html/docroot/media/images:z
    environment:
      - DOCKER_MAUTIC_ROLE=mautic_worker
      - MAUTIC_DB_HOST=${MYSQL_HOST:-mysql}
      - MAUTIC_DB_PORT=${MYSQL_PORT:-3306}
      - MAUTIC_DB_DATABASE=${MYSQL_DATABASE:-mautic}
      - MAUTIC_DB_USER=${SERVICE_USER_MYSQL}
      - MAUTIC_DB_PASSWORD=${SERVICE_PASSWORD_64_MYSQL}
      - MAUTIC_MESSENGER_DSN_EMAIL=${MAUTIC_MESSENGER_DSN_EMAIL:-amqp://guest:guest@rabbitmq:5672/mautic/messages}
      - MAUTIC_MESSENGER_DSN_HIT=${MAUTIC_MESSENGER_DSN_HIT:-amqp://guest:guest@rabbitmq:5672/mautic/messages}
    depends_on:
      mautic_web:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exit 0"]
      interval: 5s
      timeout: 10s
      retries: 15

volumes:
  mysql-data:
  rabbitmq-data:
